import streamlit as st
import requests
from urllib.parse import urlparse, parse_qs, urlencode, urlunparse

st.title("Website Vulnerability Scanner")

url = st.text_input("Enter Website URL")


# =====================================
# SAFE WEBSITE REQUEST FUNCTION
# =====================================
def fetch_url(target_url):
    try:
        headers = {
            "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64)"
        }

        response = requests.get(
            target_url,
            headers=headers,
            timeout=10,
            allow_redirects=True
        )

        return response.text.lower()

    except requests.exceptions.RequestException:
        return None


# =====================================
# HELPER → INJECT PAYLOAD INTO PARAM
# =====================================
def inject_payload(original_url, payload):

    parsed = urlparse(original_url)
    query = parse_qs(parsed.query)

    # if no parameters → cannot test
    if not query:
        return None

    # inject payload into each parameter (first one only)
    for key in query:
        query[key] = query[key][0] + payload
        break

    new_query = urlencode(query, doseq=True)

    new_url = urlunparse((
        parsed.scheme,
        parsed.netloc,
        parsed.path,
        parsed.params,
        new_query,
        parsed.fragment
    ))

    return new_url


# =====================================
# SQL INJECTION CHECK
# =====================================
def check_sql_injection(target_url):

    payload = "' OR '1'='1"
    test_url = inject_payload(target_url, payload)

    if test_url is None:
        return "No URL parameters found (cannot test SQL injection)"

    html = fetch_url(test_url)

    if html is None:
        return "Website blocked or not reachable"

    sql_errors = [
        "sql syntax",
        "mysql",
        "syntax error",
        "unclosed quotation",
        "database error",
        "warning: mysql",
        "pdo exception"
    ]

    for err in sql_errors:
        if err in html:
            return "SQL Injection vulnerability detected"

    return "No SQL Injection detected"


# =====================================
# XSS CHECK
# =====================================
def check_xss(target_url):

    payload = "<script>alert(1)</script>"
    test_url = inject_payload(target_url, payload)

    if test_url is None:
        return "No URL parameters found (cannot test XSS)"

    html = fetch_url(test_url)

    if html is None:
        return "Website blocked or not reachable"

    if payload.lower() in html:
        return "XSS vulnerability detected"

    return "No XSS detected"


# =====================================
# BUTTON ACTION
# =====================================
if st.button("Scan Website"):

    if not url:
        st.warning("Enter URL first")

    else:
        st.subheader("SQL Injection Result")
        st.write(check_sql_injection(url))

        st.subheader("XSS Result")
        st.write(check_xss(url))
